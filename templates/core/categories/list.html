{% extends "base.html" %}

{% block title %}Categories - Packing App{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Categories</h1>
</div>

<!-- Create Category Form -->
<div class="card mb-4">
    <div class="card-body">
        <form method="post" class="row g-3 align-items-end">
            {% csrf_token %}
            <div class="col-md-6 col-lg-7">
                <label for="{{ form.name.id_for_label }}" class="form-label">New Category</label>
                {{ form.name }}
                {% if form.name.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.name.errors %}{{ error }}{% endfor %}
                </div>
                {% endif %}
            </div>
            <div class="col-md-3 col-lg-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-plus-lg"></i> Add Category
                </button>
            </div>
            <div class="col-md-3 col-lg-2">
                <button type="button" class="btn btn-outline-secondary w-100" data-bs-toggle="modal" data-bs-target="#importModal">
                    <i class="bi bi-upload"></i> Import CSV
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Import Categories from CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">
                    Upload a CSV file with columns <code>category</code> and <code>item</code>.
                    The first row must be a header row.
                </p>
                <div class="mb-3">
                    <label for="csvFile" class="form-label">CSV File</label>
                    <input type="file" class="form-control" id="csvFile" accept=".csv">
                </div>
                <div id="importPreview" class="d-none">
                    <h6>Preview</h6>
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-bordered" id="previewTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Category</th>
                                    <th>Item</th>
                                </tr>
                            </thead>
                            <tbody><!-- populated by JavaScript --></tbody>
                        </table>
                    </div>
                    <p class="text-muted small mt-2" id="previewCount"></p>
                </div>
                <div id="importError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="importBtn" disabled onclick="handleImport()">
                    <span class="spinner-border spinner-border-sm d-none" id="importSpinner"></span>
                    Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Categories List -->
{% if categories %}
<div class="categories-list">
    {% for category in categories %}
    <div class="card mb-3" data-category-id="{{ category.pk }}">
        <div class="card-header d-flex align-items-center">
            <h5 class="mb-0 category-name">{{ category.name }}</h5>
            <button type="button" class="btn btn-sm btn-link text-muted edit-icon ms-2 p-0"
                    onclick="editCategory({{ category.pk }}, this)"
                    title="Edit category name">
                <i class="bi bi-pencil"></i>
            </button>
            <span class="badge bg-secondary ms-auto">{{ category.items.count }} items</span>
        </div>
        
        <!-- Items List -->
        <ul class="list-group list-group-flush" id="items-{{ category.pk }}">
            {% for item in category.items.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center" 
                data-item-id="{{ item.pk }}">
                <span class="item-name">{{ item.name }}</span>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-sm btn-outline-secondary edit-icon" 
                            onclick="editCategoryItem({{ category.pk }}, {{ item.pk }}, this)"
                            title="Edit item">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            onclick="deleteItem({{ category.pk }}, {{ item.pk }}, this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </li>
            {% empty %}
            <li class="list-group-item text-muted" id="empty-{{ category.pk }}">
                No items yet. Add some below!
            </li>
            {% endfor %}
        </ul>

        <div class="card-footer">
            <!-- Add Item Form -->
            <form class="row g-2 mb-2" onsubmit="return handleAddItem(event, {{ category.pk }})">
                <div class="col">
                    <input type="text" class="form-control form-control-sm" 
                           id="new-item-{{ category.pk }}" 
                           placeholder="New item name" required>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-plus-lg"></i> Add
                    </button>
                </div>
            </form>

            <!-- Delete Category -->
            <button type="button" class="btn btn-sm btn-outline-danger" 
                    onclick="deleteCategory({{ category.pk }}, this)">
                <i class="bi bi-trash"></i> Delete Category
            </button>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <div class="card-body empty-state">
        <i class="bi bi-tags text-muted"></i>
        <h5>No categories yet</h5>
        <p class="text-muted">Create categories to organize your packing items.</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// CSV Import functionality
let parsedCSVData = [];

document.getElementById('csvFile').addEventListener('change', handleFileSelect);

function handleFileSelect(event) {
    const file = event.target.files[0];
    const importBtn = document.getElementById('importBtn');
    const preview = document.getElementById('importPreview');
    const errorDiv = document.getElementById('importError');
    
    // Reset state
    parsedCSVData = [];
    importBtn.disabled = true;
    preview.classList.add('d-none');
    errorDiv.classList.add('d-none');
    
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const text = e.target.result;
            parsedCSVData = parseCSV(text);
            
            if (parsedCSVData.length === 0) {
                showImportError('No valid data found in CSV file.');
                return;
            }
            
            // Show preview
            showPreview(parsedCSVData);
            importBtn.disabled = false;
        } catch (error) {
            showImportError(error.message);
        }
    };
    reader.onerror = function() {
        showImportError('Failed to read file.');
    };
    reader.readAsText(file);
}

function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(line => line.trim());
    
    if (lines.length < 2) {
        throw new Error('CSV must have a header row and at least one data row.');
    }
    
    // Parse header
    const header = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
    const categoryIndex = header.indexOf('category');
    const itemIndex = header.indexOf('item');
    
    if (categoryIndex === -1 || itemIndex === -1) {
        throw new Error('CSV must have "category" and "item" columns.');
    }
    
    // Parse data rows
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const category = values[categoryIndex]?.trim();
        const item = values[itemIndex]?.trim();
        
        if (category && item) {
            data.push({ category, item });
        }
    }
    
    return data;
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current);
    
    return result;
}

function showPreview(data) {
    const preview = document.getElementById('importPreview');
    const tbody = document.querySelector('#previewTable tbody');
    const countEl = document.getElementById('previewCount');
    
    tbody.innerHTML = '';
    
    // Show first 10 rows
    const displayData = data.slice(0, 10);
    displayData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(row.category)}</td><td>${escapeHtml(row.item)}</td>`;
        tbody.appendChild(tr);
    });
    
    // Count categories
    const categories = new Set(data.map(r => r.category));
    countEl.textContent = `${data.length} items in ${categories.size} categories` + 
        (data.length > 10 ? ` (showing first 10)` : '');
    
    preview.classList.remove('d-none');
}

function showImportError(message) {
    const errorDiv = document.getElementById('importError');
    errorDiv.textContent = message;
    errorDiv.classList.remove('d-none');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function handleImport() {
    const importBtn = document.getElementById('importBtn');
    const spinner = document.getElementById('importSpinner');
    const errorDiv = document.getElementById('importError');
    
    importBtn.disabled = true;
    spinner.classList.remove('d-none');
    errorDiv.classList.add('d-none');
    
    try {
        const result = await apiRequest('/api/categories/import/', 'POST', {
            items: parsedCSVData
        });
        
        // Close modal and refresh page
        const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
        modal.hide();
        
        // Show success message and reload
        let message = `Imported ${result.items_created} items into ${result.categories_created} new categories.`;
        if (result.categories_existing > 0) {
            message += ` ${result.categories_existing} existing categories updated.`;
        }
        if (result.items_skipped > 0) {
            message += ` ${result.items_skipped} duplicate items skipped.`;
        }
        
        // Store message in sessionStorage to show after reload
        sessionStorage.setItem('importSuccess', message);
        window.location.reload();
    } catch (error) {
        showImportError(error.message);
    } finally {
        importBtn.disabled = false;
        spinner.classList.add('d-none');
    }
}

// Show success message from previous import
document.addEventListener('DOMContentLoaded', function() {
    const message = sessionStorage.getItem('importSuccess');
    if (message) {
        sessionStorage.removeItem('importSuccess');
        showAlert('success', message);
    }
});

async function handleAddItem(event, categoryId) {
    event.preventDefault();
    const input = document.getElementById(`new-item-${categoryId}`);
    const itemName = input.value.trim();
    if (!itemName) return false;

    const listElement = document.getElementById(`items-${categoryId}`);
    
    try {
        // Remove "no items" message if present
        const emptyMsg = document.getElementById(`empty-${categoryId}`);
        if (emptyMsg) emptyMsg.remove();

        const item = await addItemToCategory(categoryId, itemName, listElement);
        input.value = '';
        input.focus();
        
        // Update item count badge
        const card = document.querySelector(`[data-category-id="${categoryId}"]`);
        const badge = card.querySelector('.badge');
        const count = listElement.querySelectorAll('[data-item-id]').length;
        badge.textContent = `${count} items`;
    } catch (error) {
        console.error('Failed to add item:', error);
    }

    return false;
}
</script>
{% endblock %}
